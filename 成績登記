import streamlit as st
import easyocr
import numpy as np
import pandas as pd
from PIL import Image

# è¨­å®šç¶²é æ¨™é¡Œ
st.set_page_config(page_title="æ­·å²è€å¸«æˆç¸¾åŠ©æ‰‹", layout="centered")

# åˆå§‹åŒ– OCR å¼•æ“ (å¢åŠ å¿«å–é¿å…é‡è¤‡è¼‰å…¥)
@st.cache_resource
def load_ocr():
    # æ”¯æ´ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡/æ•¸å­—
    return easyocr.Reader(['ch_tra', 'en'])

reader = load_ocr()

st.title("ğŸ“ æ­·å²è€å¸«æˆç¸¾ç™»è¨˜åŠ©æ‰‹")
st.markdown("---")

# é¸æ“‡è¼¸å…¥æ–¹å¼
input_method = st.radio("é¸æ“‡æ–¹å¼ï¼š", ["ğŸ“· ç›´æ¥æ‹ç…§", "ğŸ–¼ï¸ å¾ç›¸å†Šé¸å–å¤šåœ–"], horizontal=True)

uploaded_files = []
if input_method == "ğŸ“· ç›´æ¥æ‹ç…§":
    img = st.camera_input("è«‹å°æº–æˆç¸¾ä½ç½®æ‹ç…§")
    if img:
        uploaded_files.append(img)
else:
    files = st.file_uploader("å¯ä¸€æ¬¡é¸å–å¤šå¼µç…§ç‰‡", accept_multiple_files=True, type=['jpg', 'png', 'jpeg'])
    if files:
        uploaded_files = files

# æš«å­˜è¾¨è­˜è³‡æ–™
if uploaded_files:
    all_results = []
    
    with st.status("æ­£åœ¨è¾¨è­˜ä¸­...", expanded=True) as status:
        for file in uploaded_files:
            image = Image.open(file)
            img_np = np.array(image)
            
            # OCR è¾¨è­˜
            results = reader.readtext(img_np)
            
            # æå–æ•¸å­—é‚è¼¯ï¼šéæ¿¾å‡ºæ‰€æœ‰ç´”æ•¸å­—
            nums = []
            for (bbox, text, prob) in results:
                # å»é™¤ç©ºç™½ä¸¦æª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­—
                clean_text = text.replace(" ", "")
                if clean_text.isdigit():
                    nums.append(int(clean_text))
            
            # åˆ¤æ–·ï¼šå‡è¨­ä¸€å¼µç…§ç‰‡ä¸­ï¼Œå°çš„æ•¸å­—æ˜¯åº§è™Ÿï¼Œå¤§çš„æ•¸å­—æ˜¯åˆ†æ•¸
            if len(nums) >= 2:
                nums.sort() # æ’åºå¾Œï¼Œæœ€å°å€¼é€šå¸¸æ˜¯åº§è™Ÿï¼Œæœ€å¤§å€¼æ˜¯åˆ†æ•¸
                all_results.append({"åº§è™Ÿ": nums[0], "åˆ†æ•¸": nums[-1]})
            else:
                st.warning(f"æª”æ¡ˆ {file.name} è¾¨è­˜æ•¸å­—ä¸è¶³(éœ€åº§è™Ÿèˆ‡åˆ†æ•¸)")
        
        status.update(label="è¾¨è­˜å®Œæˆï¼", state="complete", expanded=False)

    if all_results:
        df = pd.DataFrame(all_results)
        # ä¾åº§è™Ÿæ’åº
        df = df.sort_values(by="åº§è™Ÿ").reset_index(drop=True)
        
        st.subheader("ğŸ“Š ç™»è¨˜è¡¨ (å¯é»æ“Šæ–¹æ ¼ç›´æ¥ä¿®æ­£)")
        # é¡¯ç¤ºå¯ç·¨è¼¯è¡¨æ ¼
        edited_df = st.data_editor(df, num_rows="dynamic", use_container_width=True)
        
        # ä¸‹è¼‰æŒ‰éˆ•
        csv = edited_df.to_csv(index=False).encode('utf-8-sig')
        st.download_button(
            label="ğŸ“¥ ä¸‹è¼‰ Excel (CSV) æª”",
            data=csv,
            file_name='å­¸ç”Ÿå€‹äººæˆç¸¾å–®.csv',
            mime='text/csv',
        )
